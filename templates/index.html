
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CapaBot - AI Resume Matcher</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1 class="title">ü§ñ CapaBot</h1>
            <p class="subtitle">AI Resume Matcher & Skill Recommender</p>
        </header>

        <div class="main-content">
            <!-- Input Section -->
            <div class="input-section">
                <!-- Resume Input -->
                <div class="input-panel glass">
                    <h3>üìÑ Resume</h3>
                    <div class="input-options">
                        <button class="tab-btn active" onclick="switchInput('resume', 'text')">Paste Text</button>
                        <button class="tab-btn" onclick="switchInput('resume', 'file')">Upload File</button>
                    </div>
                    
                    <div id="resume-text-input" class="input-content">
                        <textarea id="resume-text" placeholder="Paste your resume text here... 
Example: 
Python developer with 3 years experience in web development using React and Django. Strong problem-solving skills and team collaboration."></textarea>
                    </div>
                    
                    <div id="resume-file-input" class="input-content hidden">
                        <div class="file-upload">
                            <input type="file" id="resume-file" accept=".pdf,.docx,.doc,.txt">
                            <label for="resume-file" class="file-label">
                                üìé Choose PDF, DOCX, or TXT
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Job Description Input -->
                <div class="input-panel glass">
                    <h3>üíº Job Description</h3>
                    <div class="input-options">
                        <button class="tab-btn active" onclick="switchInput('job', 'text')">Paste Text</button>
                        <button class="tab-btn" onclick="switchInput('job', 'file')">Upload File</button>
                    </div>
                    
                    <div id="job-text-input" class="input-content">
                        <textarea id="job-text" placeholder="Paste job description here...
Example:
Looking for Python Developer with React experience. Machine Learning knowledge preferred. Strong communication skills required."></textarea>
                    </div>
                    
                    <div id="job-file-input" class="input-content hidden">
                        <div class="file-upload">
                            <input type="file" id="job-file" accept=".pdf,.docx,.doc,.txt">
                            <label for="job-file" class="file-label">
                                üìé Choose PDF, DOCX, or TXT
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analyze Button -->
            <div class="analyze-section">
                <button id="analyze-btn" class="analyze-btn" onclick="analyzeMatch()">
                    üöÄ Analyze Match
                </button>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="results-section hidden">
                <!-- Match Score -->
                <div class="score-panel glass">
                    <h3>Match Score</h3>
                    <div class="score-container">
                        <canvas id="matchChart" width="200" height="200"></canvas>
                        <div class="score-text">
                            <span id="match-score" class="score">0%</span>
                            <p id="match-feedback" class="feedback">Analyzing your match...</p>
                        </div>
                    </div>
                </div>

                <!-- Skills Analysis -->
                <div class="skills-analysis">
                    <div class="skills-panel glass">
                        <h3>‚úÖ Matching Skills</h3>
                        <div id="matching-skills" class="skills-list">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <div class="skills-panel glass">
                        <h3>‚ö†Ô∏è Missing Hard Skills</h3>
                        <div id="missing-hard-skills" class="skills-list">
                            <!-- Dynamically populated -->
                        </div>
                    </div>

                    <div class="skills-panel glass">
                        <h3>üí° Missing Soft Skills</h3>
                        <div id="missing-soft-skills" class="skills-list">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="recommendations-panel glass">
                    <h3>üéØ Skill Recommendations</h3>
                    <div id="recommendations-list" class="recommendations-list">
                        <!-- Dynamically populated -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="loading" class="loading-overlay hidden">
            <div class="loading-content">
                <div class="spinner"></div>
                <p>Analyzing your resume and job description...</p>
            </div>
        </div>
    </div>

    <!-- Chatbot HTML (included directly) -->
    <div id="chatbot-widget" class="chatbot-widget">
        <!-- Chatbot Toggle Button -->
        <button id="chatbot-toggle" class="chatbot-toggle">
            <span class="chatbot-icon">üí¨</span>
            <span class="chatbot-label">AI Assistant</span>
        </button>

        <!-- Chatbot Container -->
        <div id="chatbot-container" class="chatbot-container hidden">
            <!-- Chatbot Header -->
            <div class="chatbot-header">
                <div class="chatbot-header-content">
                    <span class="chatbot-header-icon">ü§ñ</span>
                    <h4>CapaBot Assistant</h4>
                </div>
                <button id="chatbot-close" class="chatbot-close">&times;</button>
            </div>

            <!-- Chatbot Messages -->
            <div id="chatbot-messages" class="chatbot-messages">
                <div class="chat-message bot-message">
                    <div class="message-content">
                        Hello! I'm your AI assistant. I can help you with:
                        <br>‚Ä¢ Resume feedback and improvements
                        <br>‚Ä¢ Job description analysis
                        <br>‚Ä¢ Skill gap explanations
                        <br>‚Ä¢ Career advice
                        <br><br>How can I assist you today?
                    </div>
                    <div class="message-time">Just now</div>
                </div>
            </div>

            <!-- Chatbot Input -->
            <div class="chatbot-input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="chatbot-input" 
                        class="chatbot-input" 
                        placeholder="Ask about your resume, job match, or skills..."
                        rows="1"
                    ></textarea>
                    <button id="chatbot-send" class="chatbot-send-btn">
                        <span class="send-icon">‚û§</span>
                    </button>
                </div>
                <div class="chatbot-suggestions">
                    <button class="suggestion-btn" onclick="quickQuestion('Can you analyze my resume skills?')">
                        Analyze my resume
                    </button>
                    <button class="suggestion-btn" onclick="quickQuestion('What skills should I improve?')">
                        Skill improvements
                    </button>
                    <button class="suggestion-btn" onclick="quickQuestion('Explain the match score')">
                        Match score help
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <!-- Chatbot JavaScript -->
    <script>
        let currentResumeText = '';
        let currentJobText = '';
        let currentAnalysisData = null;
        let chatHistory = [];

        // Initialize chatbot
        function initChatbot() {
            const toggleBtn = document.getElementById('chatbot-toggle');
            const closeBtn = document.getElementById('chatbot-close');
            const sendBtn = document.getElementById('chatbot-send');
            const chatInput = document.getElementById('chatbot-input');
            const chatContainer = document.getElementById('chatbot-container');

            if (!toggleBtn || !closeBtn || !sendBtn || !chatInput || !chatContainer) {
                console.error('Chatbot elements not found');
                return;
            }

            // Toggle chatbot visibility
            toggleBtn.addEventListener('click', () => {
                chatContainer.classList.toggle('show');
                chatContainer.classList.toggle('hidden');
            });

            closeBtn.addEventListener('click', () => {
                chatContainer.classList.remove('show');
                chatContainer.classList.add('hidden');
            });

            // Send message on button click
            sendBtn.addEventListener('click', sendMessage);

            // Send message on Enter (with Shift for new line)
            chatInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Auto-resize textarea
            chatInput.addEventListener('input', () => {
                chatInput.style.height = 'auto';
                chatInput.style.height = Math.min(chatInput.scrollHeight, 120) + 'px';
            });

            console.log('Chatbot initialized successfully');
        }

        // Update context data from current inputs
        function updateContextData() {
            const resumeTextElem = document.getElementById('resume-text');
            const jobTextElem = document.getElementById('job-text');
            const resumeFileElem = document.getElementById('resume-file');
            const jobFileElem = document.getElementById('job-file');
            
            if (resumeTextElem) currentResumeText = resumeTextElem.value;
            if (jobTextElem) currentJobText = jobTextElem.value;
            
            // Get file names if uploaded
            if (resumeFileElem && resumeFileElem.files[0]) {
                currentResumeText += `\n[Uploaded file: ${resumeFileElem.files[0].name}]`;
            }
            
            if (jobFileElem && jobFileElem.files[0]) {
                currentJobText += `\n[Uploaded file: ${jobFileElem.files[0].name}]`;
            }
        }

        // Send message to chatbot
        async function sendMessage() {
            const input = document.getElementById('chatbot-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Update context data
                updateContextData();
                
                // Get context for the AI
                const context = {
                    hasResume: !!currentResumeText.trim(),
                    hasJob: !!currentJobText.trim(),
                    hasAnalysis: !!currentAnalysisData,
                    resumePreview: currentResumeText.substring(0, 500),
                    jobPreview: currentJobText.substring(0, 500),
                    analysis: currentAnalysisData
                };
                
                // Call backend to get AI response
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        context: context,
                        history: chatHistory.slice(-10) // Last 10 messages for context
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.success) {
                    addMessage(data.response, 'bot');
                    chatHistory.push({ role: 'user', content: message });
                    chatHistory.push({ role: 'assistant', content: data.response });
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                }
                
            } catch (error) {
                console.error('Chat error:', error);
                removeTypingIndicator();
                addMessage('Sorry, I\'m having trouble connecting. Please check your internet connection.', 'bot');
            }
        }

        // Quick question function
        function quickQuestion(question) {
            const input = document.getElementById('chatbot-input');
            input.value = question;
            input.style.height = Math.min(input.scrollHeight, 120) + 'px';
            sendMessage();
        }

        // Add message to chat UI
        function addMessage(content, sender) {
            const messagesContainer = document.getElementById('chatbot-messages');
            if (!messagesContainer) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}-message`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            messageDiv.innerHTML = `
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Show typing indicator
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatbot-messages');
            if (!messagesContainer) return;
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'typing-indicator';
            typingDiv.id = 'typing-indicator';
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initChatbot();
            
            // Override the displayResults function to update chatbot context
            const originalDisplayResults = window.displayResults;
            if (originalDisplayResults) {
                window.displayResults = function(data) {
                    originalDisplayResults(data);
                    currentAnalysisData = data;
                    
                    // Trigger chatbot event
                    const event = new CustomEvent('analysisComplete', { detail: data });
                    window.dispatchEvent(event);
                };
            }
        });

        // Export functions for use in suggestion buttons
        window.quickQuestion = quickQuestion;
    </script>
</body>
</html>
